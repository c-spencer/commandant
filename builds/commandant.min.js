(function(){var e,t,n,r=[].slice,i={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{t=require("q")}catch(o){}n=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),e=function(){function e(e,t){var r=this;this.scope=e,t==null&&(t={}),this.commands={__compound:{run:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r._run(n,"run")},undo:function(e,t){var n,i,s,o;i=t.slice(),i.reverse();for(s=0,o=i.length;s<o;s++)n=i[s],r._run(n,"undo")}}},this.opts={pedantic:t.pedantic!=null?t.pedantic:!0},this.store=new n,this._silence=!1,this._compound=null}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this._compound?this._compound.push(e):(this.store.record(e),typeof this.trigger=="function"&&this.trigger("execute",e),typeof this.onExecute=="function"&&this.onExecute(e))},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),typeof this.trigger=="function"&&this.trigger("reset",e),typeof this.onReset=="function"&&this.onReset(e)},e.prototype.register=function(e,t){this.commands[e]=t,typeof this.trigger=="function"&&this.trigger("register_command",e,t),typeof this.onRegisterCommand=="function"&&this.onRegisterCommand(e,t)},e.prototype.__silence=function(e){var t;return this._silence?t=e():(this._silence=!0,t=e(),this._silence=!1),t},e.prototype.silent=e.prototype._silence,e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?r.call(arguments,0):[],{execute:function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.execute.apply(t,[i].concat(r.call(e),r.call(n)))},"transient":function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.transient.apply(t,[i].concat(r.call(e),r.call(n)))}}},e.prototype._agg=function(e){var t,n,r;n=this._compound?this._compound[this._compound.length-1]:this.getUndoAction();if(n)if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,n,i,s,o;return s=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[s],i=n.init.apply(n,[this.scope].concat(r.call(t))),e={name:s,data:i},o=this._run(e,"run"),(this._silence||!this._agg(e))&&this._push(e),o},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),this._assert(!this._compound,"Cannot redo while compound action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),typeof this.trigger=="function"&&this.trigger("redo",e),typeof this.onRedo=="function"&&this.onRedo(e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),this._assert(!this._compound,"Cannot undo while compound action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),typeof this.trigger=="function"&&this.trigger("undo",e),typeof this.onUndo=="function"&&this.onUndo(e)},e.prototype.transient=function(){var e,t,n,i,s;i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],t=this.commands[i],this._assert(t.update!=null,"Command "+i+" does not support transient calling."),n=t.init.apply(t,[this.scope].concat(r.call(e))),s=this._run({name:i,data:n},"run"),this._transient={name:i,data:n,ret_val:s}},e.prototype.update=function(){var e;return e=1<=arguments.length?r.call(arguments,0):[],this._assert(this._transient,"Cannot update without a transient action active."),this._transient.data=this._run.apply(this,[this._transient,"update"].concat(r.call(e)))},e.prototype.finishTransient=function(){var e,t;return this._assert(this._transient,"Cannot finishTransient without a transient action active."),e={name:this._transient.name,data:this._transient.data},t=this._transient.ret_val,this._transient=null,this._agg(e)||this._push(e),t},e.prototype.cancelTransient=function(){var e;return this._assert(this._transient,"Cannot cancelTransient without a transient action active."),e=this._run(this._transient,"undo"),this._transient=null,e},e.prototype.captureCompound=function(){return this._assert(!this._transient,"Cannot captureCompound while transient action active."),this._compound=[]},e.prototype.finishCompound=function(){var e;this._assert(!this._transient,"Cannot finishCompound while transient action active."),this._assert(this._compound,"Cannot finishCompound without compound capture active."),e=this._compound,this._compound=null,this._push({name:"__compound",data:e})},e.prototype.cancelCompound=function(){var e;return this._assert(this._compound,"Cannot cancelCompound without compound capture active."),e=this.commands.__compound.undo(this.scope,this._compound),this._compound=null,e},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(){var e,t,n,i,s,o=this;return e=arguments[0],i=arguments[1],t=3<=arguments.length?r.call(arguments,2):[],n=this.commands[e.name],s=n.scope?n.scope(this.scope,e.data):this.scope,this.__silence(function(){return n[i].apply(n,[s,e.data].concat(r.call(t)))})},e}(),e.Async=function(n){function i(){var e=this;i.__super__.constructor.apply(this,arguments),this.commands={__compound:{run:function(n,r){var i,s,o,u,a;s=t.when(void 0),o=function(t){return s=s.then(function(){return e._run(t,"run")})};for(u=0,a=r.length;u<a;u++)i=r[u],o(i);return s},undo:function(n,r){var i,s,o,u,a,f;o=t.when(void 0),s=r.slice(),s.reverse(),u=function(t){return o=o.then(function(){return e._run(t,"undo")})};for(a=0,f=r.length;a<f;a++)i=r[a],u(i);return o}}};if(typeof t=="undefined")throw"Cannot run in asynchronous mode without Q available.";this._running=null,this._deferQueue=[]}return s(i,n),i.prototype.__silence=function(e){var n,r=this;return this._silence?n=t.when(e()):(this._silence=!0,n=t.when(e()).fin(function(){return r._silence=!1})),n},i.prototype.silent=function(e){return this._defer(this.__silence,e)},i.prototype._defer=function(){var e,n,i,s,o=this;return s=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],i=t.defer(),n=function(){return t.when(s.apply(o,e)).then(function(e){return i.resolve(e)},function(e){return console.log("Encountered error in deferred fn",e),i.reject(e)})},this._deferQueue.push(n),this._running||this._runDefer(),i.promise},i.prototype._runDefer=function(){var e,t=this;if(this._running||this._deferQueue.length===0)return;e=this._deferQueue.shift(),this._running=e(),this._running.fin(function(){return t._running=null,t._runDefer()})},i.prototype.execute=function(){var e,t;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],this._defer(this._executeAsync,t,e)},i.prototype._executeAsync=function(e,n){var i,s,o=this;return this._assert(!this._transient,"Cannot execute while transient action active."),s=this.commands[e],i=null,t.resolve(s.init.apply(s,[this.scope].concat(r.call(n)))).then(function(n){return i={name:e,data:n},t.resolve(o._run(i,"run"))}).then(function(e){return(o._silence||!o._agg(i))&&o._push(i),e})},i.prototype.redo=function(){return this._defer(this._redoAsync)},i.prototype._redoAsync=function(){var e,n=this;return this._assert(!this._transient,"Cannot redo while transient action active."),this._assert(!this._compound,"Cannot redo while compound action active."),e=this.getRedoActions(!0),e?t.when(this._run(e,"run")).then(function(){return typeof n.trigger=="function"&&n.trigger("redo",e),typeof n.onRedo=="function"?n.onRedo(e):void 0}):t.resolve(void 0)},i.prototype.undo=function(){return this._defer(this._undoAsync)},i.prototype._undoAsync=function(){var e,n=this;return this._assert(!this._transient,"Cannot undo while transient action active."),this._assert(!this._compound,"Cannot undo while compound action active."),e=this.getUndoAction(!0),e?t.when(this._run(e,"undo")).then(function(){return typeof n.trigger=="function"&&n.trigger("undo",e),typeof n.onUndo=="function"?n.onUndo(e):void 0}):t.resolve(void 0)},i.prototype.captureCompound=function(){return this._defer(e.prototype.captureCompound)},i.prototype.finishCompound=function(){return this._defer(e.prototype.finishCompound)},i.prototype.cancelCompound=function(){return this._defer(e.prototype.cancelCompound)},i.prototype.transient=function(){var e,t;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],this._defer(this._transientAsync,t,e)},i.prototype._transientAsync=function(e,n){var i,s=this;return i=this.commands[e],this._assert(i.update!=null,"Command "+e+" does not support transient calling."),this._transient={name:e},t.when(i.init.apply(i,[this.scope].concat(r.call(n)))).then(function(e){return s._transient.data=e,t.when(s._run(s._transient,"run"))}).then(function(e){return s._transient.ret_val=e})},i.prototype.update=function(){var e;return e=1<=arguments.length?r.call(arguments,0):[],this._defer(this._updateAsync,e)},i.prototype._updateAsync=function(e){var n=this;return this._assert(this._transient,"Cannot update without a transient action active."),t.when(this._run.apply(this,[this._transient,"update"].concat(r.call(e)))).then(function(e){return n._transient.data=e})},i.prototype.finishTransient=function(){return this._defer(e.prototype.finishTransient)},i.prototype.cancelTransient=function(){return this._defer(e.prototype.cancelTransient)},i}(e),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}).call(this);