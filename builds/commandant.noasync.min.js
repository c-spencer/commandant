(function(){var e,t,n,r=[].slice,i={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};n=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),e=function(){function e(e,t){var r=this;this.scope=e,t==null&&(t={}),this.commands={__compound:{run:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r._run(n,"run")},undo:function(e,t){var n,i,s,o;i=t.slice(),i.reverse();for(s=0,o=i.length;s<o;s++)n=i[s],r._run(n,"undo")}}},this.opts={pedantic:t.pedantic!=null?t.pedantic:!0},this.store=new n,this._silence=!1,this._compound=null}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype._hook=function(e,t){var n;return typeof this.trigger=="function"&&this.trigger(e.toLowerCase(),t),typeof this[n="on"+e]=="function"&&this[n](t),typeof this.trigger=="function"&&this.trigger("change",e,t),typeof this.onChange=="function"?this.onChange(e,t):void 0},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this._compound?this._compound.push(e):(this.store.record(e),this._hook("Execute",e))},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),this._hook("Reset",e)},e.prototype.register=function(e,t){this.commands[e]=t},e.prototype.__silence=function(e){var t;return this._silence?t=e():(this._silence=!0,t=e(),this._silence=!1),t},e.prototype.silent=e.prototype._silence,e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?r.call(arguments,0):[],{execute:function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.execute.apply(t,[i].concat(r.call(e),r.call(n)))},"transient":function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.transient.apply(t,[i].concat(r.call(e),r.call(n)))}}},e.prototype._agg=function(e){var t,n,r;n=this._compound?this._compound[this._compound.length-1]:this.getUndoAction();if(n)if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,n,i,s,o;return s=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[s],i=n.init.apply(n,[this.scope].concat(r.call(t))),e={name:s,data:i},o=this._run(e,"run"),(this._silence||!this._agg(e))&&this._push(e),o},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),this._assert(!this._compound,"Cannot redo while compound action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),this._hook("Redo",e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),this._assert(!this._compound,"Cannot undo while compound action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),this._hook("Undo",e)},e.prototype.transient=function(){var e,t,n,i,s;i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],t=this.commands[i],this._assert(t.update!=null,"Command "+i+" does not support transient calling."),n=t.init.apply(t,[this.scope].concat(r.call(e))),s=this._run({name:i,data:n},"run"),this._transient={name:i,data:n,ret_val:s},this._hook("Update",this._transient)},e.prototype.update=function(){var e;e=1<=arguments.length?r.call(arguments,0):[],this._assert(this._transient,"Cannot update without a transient action active."),this._transient.data=this._run.apply(this,[this._transient,"update"].concat(r.call(e))),this._hook("Update",this._transient)},e.prototype.finishTransient=function(){var e,t;return this._assert(this._transient,"Cannot finishTransient without a transient action active."),e={name:this._transient.name,data:this._transient.data},t=this._transient.ret_val,this._transient=null,this._agg(e)||this._push(e),t},e.prototype.cancelTransient=function(){var e;return this._assert(this._transient,"Cannot cancelTransient without a transient action active."),e=this._run(this._transient,"undo"),this._transient=null,e},e.prototype.captureCompound=function(){return this._assert(!this._transient,"Cannot captureCompound while transient action active."),this._compound=[]},e.prototype.finishCompound=function(){var e;this._assert(!this._transient,"Cannot finishCompound while transient action active."),this._assert(this._compound,"Cannot finishCompound without compound capture active."),e=this._compound,this._compound=null,this._push({name:"__compound",data:e})},e.prototype.cancelCompound=function(){var e;return this._assert(this._compound,"Cannot cancelCompound without compound capture active."),e=this.commands.__compound.undo(this.scope,this._compound),this._compound=null,e},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(){var e,t,n,i,s,o=this;return e=arguments[0],i=arguments[1],t=3<=arguments.length?r.call(arguments,2):[],n=this.commands[e.name],s=n.scope?n.scope(this.scope,e.data):this.scope,this.__silence(function(){return n[i].apply(n,[s,e.data].concat(r.call(t)))})},e}(),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}).call(this);