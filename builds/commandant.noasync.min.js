(function(){StackStore=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),Commandant=function(){function e(e,t){var n=this;this.scope=e,t==null&&(t={}),this.commands={__compound:{run:function(e,t){var r,i,s;for(i=0,s=t.length;i<s;i++)r=t[i],n._run(r,"run")},undo:function(e,t){var r,i,s,o;i=t.slice(),i.reverse();for(s=0,o=i.length;s<o;s++)r=i[s],n._run(r,"undo")}}},this.opts={pedantic:t.pedantic!=null?t.pedantic:!0},this.store=new StackStore,this._silence=!1,this._compound=null}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this._compound?this._compound.push(e):(this.store.record(e),typeof this.trigger=="function"&&this.trigger("execute",e),typeof this.onExecute=="function"&&this.onExecute(e))},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),typeof this.trigger=="function"&&this.trigger("reset",e),typeof this.onReset=="function"&&this.onReset(e)},e.prototype.register=function(e,t){this.commands[e]=t,typeof this.trigger=="function"&&this.trigger("register_command",e,t),typeof this.onRegisterCommand=="function"&&this.onRegisterCommand(e,t)},e.prototype.__silence=function(e){var t;return this._silence?t=e():(this._silence=!0,t=e(),this._silence=!1),t},e.prototype.silent=e.prototype._silence,e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?__slice.call(arguments,0):[],{execute:function(){var n,r;return r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],t.execute.apply(t,[r].concat(__slice.call(e),__slice.call(n)))},"transient":function(){var n,r;return r=arguments[0],n=2<=arguments.length?__slice.call(arguments,1):[],t.transient.apply(t,[r].concat(__slice.call(e),__slice.call(n)))}}},e.prototype._agg=function(e){var t,n,r;n=this._compound?this._compound[this._compound.length-1]:this.getUndoAction();if(n)if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,n,r,i,s;return i=arguments[0],t=2<=arguments.length?__slice.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[i],r=n.init.apply(n,[this.scope].concat(__slice.call(t))),e={name:i,data:r},s=this._run(e,"run"),(this._silence||!this._agg(e))&&this._push(e),s},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),this._assert(!this._compound,"Cannot redo while compound action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),typeof this.trigger=="function"&&this.trigger("redo",e),typeof this.onRedo=="function"&&this.onRedo(e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),this._assert(!this._compound,"Cannot undo while compound action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),typeof this.trigger=="function"&&this.trigger("undo",e),typeof this.onUndo=="function"&&this.onUndo(e)},e.prototype.transient=function(){var e,t,n,r,i;r=arguments[0],e=2<=arguments.length?__slice.call(arguments,1):[],t=this.commands[r],this._assert(t.update!=null,"Command "+r+" does not support transient calling."),n=t.init.apply(t,[this.scope].concat(__slice.call(e))),i=this._run({name:r,data:n},"run"),this._transient={name:r,data:n,ret_val:i}},e.prototype.update=function(){var e;return e=1<=arguments.length?__slice.call(arguments,0):[],this._assert(this._transient,"Cannot update without a transient action active."),this._transient.data=this._run.apply(this,[this._transient,"update"].concat(__slice.call(e)))},e.prototype.finishTransient=function(){var e,t;return this._assert(this._transient,"Cannot finishTransient without a transient action active."),e={name:this._transient.name,data:this._transient.data},t=this._transient.ret_val,this._transient=null,this._agg(e)||this._push(e),t},e.prototype.cancelTransient=function(){var e;return this._assert(this._transient,"Cannot cancelTransient without a transient action active."),e=this._run(this._transient,"undo"),this._transient=null,e},e.prototype.captureCompound=function(){return this._assert(!this._transient,"Cannot captureCompound while transient action active."),this._compound=[]},e.prototype.finishCompound=function(){var e;this._assert(!this._transient,"Cannot finishCompound while transient action active."),this._assert(this._compound,"Cannot finishCompound without compound capture active."),e=this._compound,this._compound=null,this._push({name:"__compound",data:e})},e.prototype.cancelCompound=function(){var e;return this._assert(this._compound,"Cannot cancelCompound without compound capture active."),e=this.commands.__compound.undo(this.scope,this._compound),this._compound=null,e},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(){var e,t,n,r,i,s=this;return e=arguments[0],r=arguments[1],t=3<=arguments.length?__slice.call(arguments,2):[],n=this.commands[e.name],i=n.scope?n.scope(this.scope,e.data):this.scope,this.__silence(function(){return n[r].apply(n,[i,e.data].concat(__slice.call(t)))})},e}(),typeof module!="undefined"?module.exports=Commandant:typeof define=="function"&&define.amd?define(function(){return Commandant}):window.Commandant=Commandant}).call(this);