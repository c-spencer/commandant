(function(){var e,t,n=[].slice;t=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),e=function(){function e(e,r){var i=this;this.scope=e,r==null&&(r={}),this.commands={__compound:{init:function(){return[]},run:function(e,t){var n,r,s;for(r=0,s=t.length;r<s;r++)n=t[r],i.commands[n.name].run(e,n.data)},update:function(){var e,t,r,s,o,u;return u=arguments[0],o=arguments[1],s=arguments[2],e=4<=arguments.length?n.call(arguments,3):[],t=i.commands[s],r=t.init.apply(t,[i.scope].concat(n.call(e))),o.push({name:s,data:r}),i._run({name:s,data:r},"run")},undo:function(e,t){var n,r,s;for(r=0,s=t.length;r<s;r++)n=t[r],i.commands[n.name].undo(e,n.data)}}},this.opts={pedantic:r.pedantic!=null?r.pedantic:!0},this.store=new t}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this.store.record(e),typeof this.trigger=="function"&&this.trigger("execute",e),typeof this.onExecute=="function"&&this.onExecute(e)},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),typeof this.trigger=="function"&&this.trigger("reset",e),typeof this.onReset=="function"&&this.onReset(e)},e.prototype.register=function(e,t){this.commands[e]=t,typeof this.trigger=="function"&&this.trigger("register_command",e,t),typeof this.onRegisterCommand=="function"&&this.onRegisterCommand(e,t)},e.prototype.silent=function(e){var t;return this._silent?t=e():(this._silent=!0,t=e(),this._silent=!1),t},e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?n.call(arguments,0):[],{execute:function(){var r,i;return i=arguments[0],r=2<=arguments.length?n.call(arguments,1):[],t.execute.apply(t,[i].concat(n.call(e),n.call(r)))},"transient":function(){var r,i;return i=arguments[0],r=2<=arguments.length?n.call(arguments,1):[],t.transient.apply(t,[i].concat(n.call(e),n.call(r)))}}},e.prototype._agg=function(e){var t,n,r;if(n=this.getUndoAction())if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,r,i,s,o;return s=arguments[0],t=2<=arguments.length?n.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),r=this.commands[s],i=r.init.apply(r,[this.scope].concat(n.call(t))),e={name:s,data:i},o=this._run(e,"run"),(this._silent||!this._agg(e))&&this._push(e),o},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),typeof this.trigger=="function"&&this.trigger("redo",e),typeof this.onRedo=="function"&&this.onRedo(e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),typeof this.trigger=="function"&&this.trigger("undo",e),typeof this.onUndo=="function"&&this.onUndo(e)},e.prototype.transient=function(){var e,t,r,i,s,o=this;return i=arguments[0],e=2<=arguments.length?n.call(arguments,1):[],t=this.commands[i],this._assert(t.update!=null,"Command "+i+" does not support transient calling."),this._transient=!0,this._silent=!0,r=t.init.apply(t,[this.scope].concat(n.call(e))),s=t.run(this._scope(t,r),r),{update:function(){var e;e=1<=arguments.length?n.call(arguments,0):[],r=t.update.apply(t,[o._scope(t,r),r].concat(n.call(e)))},finish:function(){var e;return o._transient=!1,o._silent=!1,e={name:i,data:r},o._agg(e)||o._push(e),s},cancel:function(){t.undo(scope,r),o._transient=!1,o._silent=!1}}},e.prototype.compound=function(){return this.transient("__compound",[])},e.prototype._scope=function(e,t){return e.scope?e.scope(this.scope,t):this.scope},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(e,t){var n,r=this;return n=this.commands[e.name],this.silent(function(){return n[t](r._scope(n,e.data),e.data)})},e}(),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}).call(this);