(function(){var e,t=[].slice;e=function(){function e(e,n){var r=this;this.scope=e,n==null&&(n={}),this.commands={__compound:{init:function(){return[]},run:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r.commands[n.name].run(e,n.data)},update:function(){var e,n,i,s,o,u;return u=arguments[0],o=arguments[1],s=arguments[2],e=4<=arguments.length?t.call(arguments,3):[],n=r.commands[s],i=n.init.apply(n,[r.scope].concat(t.call(e))),o.push({name:s,data:i}),r._run({name:s,data:i},"run")},undo:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r.commands[n.name].undo(e,n.data)}}},this.opts={pedantic:n.pedantic!=null?n.pedantic:!0},this.stack=[],this.stack_idx=0,this._silent=!1,this._transient=!1}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.stackStats=function(){return{length:this.stack.length,position:this.stack_idx}},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.stack_idx)this.undo();else this.stack_idx=0;this.stack=[]},e.prototype.register=function(e,t){this.commands[e]=t},e.prototype.silent=function(e){var t;return this._silent=!0,t=e(),this._silent=!1,t},e.prototype.bind=function(){var e,n=this;return e=1<=arguments.length?t.call(arguments,0):[],{execute:function(){var r,i;return i=arguments[0],r=2<=arguments.length?t.call(arguments,1):[],n.execute.apply(n,[i].concat(t.call(e),t.call(r)))},"transient":function(){var r,i;return i=arguments[0],r=2<=arguments.length?t.call(arguments,1):[],n.transient.apply(n,[i].concat(t.call(e),t.call(r)))}}},e.prototype.execute=function(){var e,n,r,i,s;return i=arguments[0],e=2<=arguments.length?t.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[i],r=n.init.apply(n,[this.scope].concat(t.call(e))),s=this._run({name:i,data:r},"run"),this._silent||this._push({name:i,data:r}),s},e.prototype.redo=function(){if(this.stack_idx===this.stack.length)return;this._assert(!this._transient,"Cannot redo while transient action active."),this._run(this.stack[this.stack_idx],"run"),++this.stack_idx},e.prototype.undo=function(){if(this.stack_idx===0)return;this._assert(!this._transient,"Cannot undo while transient action active."),--this.stack_idx,this._run(this.stack[this.stack_idx],"undo")},e.prototype.transient=function(){var e,n,r,i,s,o=this;return i=arguments[0],e=2<=arguments.length?t.call(arguments,1):[],n=this.commands[i],this._assert(n.update!=null,"Command "+i+" does not support transient calling."),this._transient=!0,this._silent=!0,r=n.init.apply(n,[this.scope].concat(t.call(e))),s=n.run(this._scope(n,r),r),{update:function(){var e;e=1<=arguments.length?t.call(arguments,0):[],n.update.apply(n,[o._scope(n,r),r].concat(t.call(e)))},finish:function(){return o._push({name:i,data:r}),o._transient=!1,o._silent=!1,s},cancel:function(){n.undo(scope,r),o._transient=!1,o._silent=!1}}},e.prototype.compound=function(){return this.transient("__compound",[])},e.prototype._scope=function(e,t){return e.scope?e.scope(this.scope,t):this.scope},e.prototype._push=function(e){this.stack.splice(this.stack_idx,Infinity),this.stack.push(e),this.stack_idx=this.stack.length},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(e,t){var n,r=this;return n=this.commands[e.name],this.silent(function(){return n[t](r._scope(n,e.data),e.data)})},e}(),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}).call(this);