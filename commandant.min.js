(function(){var e,t,n,r=[].slice,i={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{t=require("q")}catch(o){}n=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),e=function(){function e(e,t){var r=this;this.scope=e,t==null&&(t={}),this.commands={__compound:{run:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r._run(n,"run")},undo:function(e,t){var n,i,s;for(i=0,s=t.length;i<s;i++)n=t[i],r._run(n,"undo")}}},this.opts={pedantic:t.pedantic!=null?t.pedantic:!0},this.store=new n,this._compound=null}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this._compound?this._compound.push(e):(this.store.record(e),typeof this.trigger=="function"&&this.trigger("execute",e),typeof this.onExecute=="function"&&this.onExecute(e))},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),typeof this.trigger=="function"&&this.trigger("reset",e),typeof this.onReset=="function"&&this.onReset(e)},e.prototype.register=function(e,t){this.commands[e]=t,typeof this.trigger=="function"&&this.trigger("register_command",e,t),typeof this.onRegisterCommand=="function"&&this.onRegisterCommand(e,t)},e.prototype.silent=function(e){var t;return this._silent?t=e():(this._silent=!0,t=e(),this._silent=!1),t},e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?r.call(arguments,0):[],{execute:function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.execute.apply(t,[i].concat(r.call(e),r.call(n)))},"transient":function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.transient.apply(t,[i].concat(r.call(e),r.call(n)))}}},e.prototype._agg=function(e){var t,n,r;n=this._compound?this._compound[this._compound.length-1]:this.getUndoAction();if(n)if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,n,i,s,o;return s=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[s],i=n.init.apply(n,[this.scope].concat(r.call(t))),e={name:s,data:i},o=this._run(e,"run"),(this._silent||!this._agg(e))&&this._push(e),o},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),this._assert(!this._compound,"Cannot redo while compound action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),typeof this.trigger=="function"&&this.trigger("redo",e),typeof this.onRedo=="function"&&this.onRedo(e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),this._assert(!this._compound,"Cannot undo while compound action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),typeof this.trigger=="function"&&this.trigger("undo",e),typeof this.onUndo=="function"&&this.onUndo(e)},e.prototype.transient=function(){var e,t,n,i,s,o=this;return i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],t=this.commands[i],this._assert(t.update!=null,"Command "+i+" does not support transient calling."),this._transient=!0,this._silent=!0,n=t.init.apply(t,[this.scope].concat(r.call(e))),s=t.run(this._scope(t,n),n),{update:function(){var e;e=1<=arguments.length?r.call(arguments,0):[],n=t.update.apply(t,[o._scope(t,n),n].concat(r.call(e)))},finish:function(){var e;return o._transient=!1,o._silent=!1,e={name:i,data:n},o._agg(e)||o._push(e),s},cancel:function(){t.undo(scope,n),o._transient=!1,o._silent=!1}}},e.prototype.captureCompound=function(){return this._assert(!this._transient,"Cannot captureCompound while transient action active."),this._compound=[]},e.prototype.finishCompound=function(){var e;this._assert(!this._transient,"Cannot finishCompound while transient action active."),e=this._compound,this._compound=null,this._push({name:"__compound",data:e})},e.prototype._scope=function(e,t){return e.scope?e.scope(this.scope,t):this.scope},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(e,t){var n,r=this;return n=this.commands[e.name],this.silent(function(){return n[t](r._scope(n,e.data),e.data)})},e}(),e.Async=function(e){function n(){n.__super__.constructor.apply(this,arguments);if(typeof t=="undefined")throw"Cannot run in asynchronous mode without Q available.";this._running=null,this._deferQueue=[]}return s(n,e),n.prototype.silent=function(e){var n,r=this;return this._silent?n=t.resolve(e()):(this._silent=!0,n=t.resolve(e()),n.fin(function(){return r._silent=!1})),n},n.prototype._defer=function(){var e,n,i,s,o=this;return s=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],n=t.defer(),i=function(){var r;return r=t.resolve(o[s].apply(o,e)),r.then(function(e){return n.resolve(e)})},this._deferQueue.push(i),this._running||this._runDefer(),n.promise},n.prototype._runDefer=function(){var e,t=this;if(this._running||this._deferQueue.length===0)return;e=this._deferQueue.shift(),this._running=e(),this._running.then(function(){return t._running=null,t._runDefer()},function(e){return t._running=null,console.log("!! deferred function errored")})},n.prototype.execute=function(){var e,t;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),this._defer("_executeAsync",t,e)},n.prototype._executeAsync=function(e,n){var i,s,o,u=this;return i=this.commands[e],o=t.defer(),s=t.resolve(i.init.apply(i,[this.scope].concat(r.call(n)))),s.then(function(n){var r,i;return r={name:e,data:n},i=t.resolve(u._run(r,"run")),i.then(function(e){return(u._silent||!u._agg(r))&&u._push(r),o.resolve(e)})}),o.promise},n.prototype.redo=function(){return this._assert(!this._transient,"Cannot redo while transient action active."),this._defer("_redoAsync")},n.prototype._redoAsync=function(){var e,n,r=this;return e=this.getRedoActions(!0),e?(n=t.resolve(this._run(e,"run")),n.then(function(){return typeof r.trigger=="function"&&r.trigger("redo",e),typeof r.onRedo=="function"?r.onRedo(e):void 0}),n):t.resolve(void 0)},n.prototype.undo=function(){return this._assert(!this._transient,"Cannot undo while transient action active."),this._defer("_undoAsync")},n.prototype._undoAsync=function(){var e,n,r=this;return e=this.getUndoAction(!0),e?(n=t.resolve(this._run(e,"undo")),n.then(function(){return typeof r.trigger=="function"&&r.trigger("undo",e),typeof r.onUndo=="function"?r.onUndo(e):void 0}),n):t.resolve(void 0)},n.prototype.captureCompound=function(){throw"Compound not yet supported in Async mode"},n.prototype.transient=function(){throw"Transient not yet supported in Async mode"},n}(e),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}).call(this);