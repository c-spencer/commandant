(function(e){if(typeof bootstrap=="function")bootstrap("promise",e);else if(typeof exports=="object")e(void 0,exports);else if(typeof define=="function")define(e);else if(typeof ses!="undefined"){if(!ses.ok())return;ses.makeQ=function(){var t={};return e(void 0,t)}}else e(void 0,Q={})})(function(e,t){"use strict";function b(e){return y(e)==="[object StopIteration]"||e instanceof w}function S(e,t){t.stack&&typeof e=="object"&&e!==null&&e.stack&&e.stack.indexOf(E)===-1&&(e.stack=x(e.stack)+"\n"+E+"\n"+x(t.stack))}function x(e){var t=e.split("\n"),n=[];for(var r=0;r<t.length;++r){var i=t[r];!N(i)&&!T(i)&&n.push(i)}return n.join("\n")}function T(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function N(e){var t=/at .+ \((.*):(\d+):\d+\)/.exec(e);if(!t)return!1;var i=t[1],s=t[2];return i===r&&s>=n&&s<=Tt}function C(){if(Error.captureStackTrace){var e,t,n=Error.prepareStackTrace;return Error.prepareStackTrace=function(n,r){e=r[1].getFileName(),t=r[1].getLineNumber()},(new Error).stack,Error.prepareStackTrace=n,r=e,t}}function k(e,t,n){return function(){return typeof console!="undefined"&&typeof console.warn=="function"&&console.warn(t+" is deprecated, use "+n+" instead.",(new Error("")).stack),e.apply(e,arguments)}}function L(){function u(r){if(!e)return;n=R(r),p(e,function(e,t){o(function(){n.promiseSend.apply(n,t)})},void 0),e=void 0,t=void 0}var e=[],t=[],n,r=m(L.prototype),i=m(O.prototype);return i.promiseSend=function(r,i,s,u){var a=h(arguments);e?(e.push(a),r==="when"&&u&&t.push(u)):o(function(){n.promiseSend.apply(n,a)})},i.valueOf=function(){return e?i:n.valueOf()},Error.captureStackTrace&&(Error.captureStackTrace(i,L),i.stack=i.stack.substring(i.stack.indexOf("\n")+1)),s(i),r.promise=i,r.resolve=u,r.reject=function(e){u(q(e))},r.notify=function(n){e&&p(t,function(e,t){o(function(){t(n)})},void 0)},r}function A(e){var t=L();return it(e,t.resolve,t.reject,t.notify).fail(t.reject),t.promise}function O(e,t,n,r){t===void 0&&(t=function(e){return q(new Error("Promise does not support operation: "+e))});var i=m(O.prototype);return i.promiseSend=function(n,r){var s=h(arguments,2),o;try{e[n]?o=e[n].apply(i,s):o=t.apply(i,[n].concat(s))}catch(u){o=q(u)}r&&r(o)},n&&(i.valueOf=n),r&&(i.exception=r),s(i),i}function M(e){return _(e)?e.valueOf():e}function _(e){return e&&typeof e.promiseSend=="function"}function D(e){return P(e)||H(e)}function P(e){return!_(M(e))}function H(e){return e=M(e),_(e)&&"exception"in e}function I(){!F&&typeof window!="undefined"&&!window.Touch&&window.console&&console.log("Should be empty:",j),F=!0}function q(e){e=e||new Error;var t=O({when:function(t){if(t){var n=d(B,this);n!==-1&&(j.splice(n,1),B.splice(n,1))}return t?t(e):q(e)}},function(){return q(e)},function n(){return this},e);return I(),B.push(t),j.push(e),t}function R(e){if(_(e))return e;e=M(e);if(e&&typeof e.then=="function"){var t=L();return e.then(t.resolve,t.reject,t.notify),t.promise}return O({when:function(){return e},get:function(t){return e[t]},put:function(t,n){return e[t]=n,e},del:function(t){return delete e[t],e},post:function(t,n){return e[t].apply(e,n)},apply:function(t,n){return e.apply(t,n)},fapply:function(t){return e.apply(void 0,t)},viewInfo:function(){function r(e){n[e]||(n[e]=typeof t[e])}var t=e,n={};while(t)Object.getOwnPropertyNames(t).forEach(r),t=Object.getPrototypeOf(t);return{type:typeof e,properties:n}},keys:function(){return g(e)}},void 0,function n(){return e})}function U(e){return O({isDef:function(){}},function(){var n=h(arguments);return G.apply(void 0,[e].concat(n))},function(){return M(e)})}function z(e,t){return e=R(e),t?O({viewInfo:function(){return t}},function(){var n=h(arguments);return G.apply(void 0,[e].concat(n))},function(){return M(e)}):G(e,"viewInfo")}function W(e){return z(e).when(function(t){var n;t.type==="function"?n=function(){return tt(e,void 0,arguments)}:n={};var r=t.properties||{};return g(r).forEach(function(t){r[t]==="function"&&(n[t]=function(){return et(e,t,arguments)})}),R(n)})}function X(e,t,n,r){function u(e){try{return t?t(e):e}catch(n){return q(n)}}function a(e){if(n){S(e,l);try{return n(e)}catch(t){return q(t)}}return q(e)}function f(e){return r?r(e):e}var i=L(),s=!1,l=R(e);return o(function(){l.promiseSend("when",function(e){if(s)return;s=!0,i.resolve(u(e))},function(e){if(s)return;s=!0,i.resolve(a(e))})}),l.promiseSend("when",void 0,void 0,function(e){i.notify(f(e))}),i.promise}function V(e,t,n){return X(e,function(e){return ut(e).then(function(e){return t.apply(void 0,e)},n)},n)}function $(e){return function(){function t(e,t){var s;try{s=n[e](t)}catch(o){return b(o)?o.value:q(o)}return X(s,r,i)}var n=e.apply(this,arguments),r=t.bind(t,"send"),i=t.bind(t,"throw");return r()}}function J(e){throw new w(e)}function K(e){return function(){return ut([this,ut(arguments)]).spread(function(t,n){return e.apply(t,n)})}}function Q(e){return function(t){var n=h(arguments,1);return G.apply(void 0,[t,e].concat(n))}}function G(e,t){var n=L(),r=h(arguments,2);return e=R(e),o(function(){e.promiseSend.apply(e,[t,n.resolve].concat(r))}),n.promise}function Y(e,t,n){var r=L();return e=R(e),o(function(){e.promiseSend.apply(e,[t,r.resolve].concat(n))}),r.promise}function Z(e){return function(t){var n=h(arguments,1);return Y(t,e,n)}}function rt(e,t){var n=h(arguments,2);return tt(e,t,n)}function it(e){var t=h(arguments,1);return nt(e,t)}function st(e,t){var n=h(arguments,2);return function(){var i=n.concat(h(arguments));return tt(e,t,i)}}function ot(e){var t=h(arguments,1);return function(){var r=t.concat(h(arguments));return nt(e,r)}}function ut(e){return X(e,function(e){var t=e.length;if(t===0)return R(e);var n=L();return p(e,function(r,i,s){P(i)?(e[s]=M(i),--t===0&&n.resolve(e)):X(i,function(r){e[s]=r,--t===0&&n.resolve(e)}).fail(n.reject)},void 0),n.promise})}function at(e){return X(e,function(e){return X(ut(v(e,function(e){return X(e,i,i)})),function(){return v(e,R)})})}function ft(e,t){return X(e,void 0,t)}function lt(e,t){return X(e,void 0,void 0,t)}function ct(e,t){return X(e,function(e){return X(t(),function(){return e})},function(e){return X(t(),function(){return q(e)})})}function ht(e,n,r,i){function s(n){o(function(){S(n,e);if(!t.onerror)throw n;t.onerror(n)})}var u=n||r||i?X(e,n,r,i):e;ft(u,s)}function pt(e,t){var n=L(),r=setTimeout(function(){n.reject(new Error("Timed out after "+t+" ms"))},t);return X(e,function(e){clearTimeout(r),n.resolve(e)},function(e){clearTimeout(r),n.reject(e)}),n.promise}function dt(e,t){t===void 0&&(t=e,e=void 0);var n=L();return setTimeout(function(){n.resolve(e)},t),n.promise}function vt(e,t){var n=h(t),r=L();return n.push(r.makeNodeResolver()),nt(e,n).fail(r.reject),r.promise}function mt(e){var t=h(arguments,1),n=L();return t.push(n.makeNodeResolver()),nt(e,t).fail(n.reject),n.promise}function gt(e){var t=h(arguments,1);return function(){var n=t.concat(h(arguments)),r=L();return n.push(r.makeNodeResolver()),nt(e,n).fail(r.reject),r.promise}}function yt(e,t,n){return wt(e,t).apply(void 0,n)}function bt(e,t){var n=h(arguments,2);return yt(e,t,n)}function wt(e){if(arguments.length>1){var t=arguments[1],n=h(arguments,2),r=e;e=function(){var e=n.concat(h(arguments));return r.apply(t,e)}}return function(){var t=L(),n=h(arguments);return n.push(t.makeNodeResolver()),nt(e,n).fail(t.reject),t.promise}}function Et(e,t,n){var r=h(n),i=L();return r.push(i.makeNodeResolver()),et(e,t,r).fail(i.reject),i.promise}function St(e,t){var n=h(arguments,2),r=L();return n.push(r.makeNodeResolver()),et(e,t,n).fail(r.reject),r.promise}function xt(e,t){if(!t)return e;e.then(function(e){o(function(){t(null,e)})},function(e){o(function(){t(e)})})}var n=C(),r,i=function(){},s=Object.freeze||i;typeof cajaVM!="undefined"&&(s=cajaVM.def);var o;if(typeof process!="undefined")o=process.nextTick;else if(typeof setImmediate=="function")o=setImmediate;else if(typeof MessageChannel!="undefined"){var u=new MessageChannel,a={},f=a;u.port1.onmessage=function(){a=a.next;var e=a.task;delete a.task,e()},o=function(e){f=f.next={task:e},u.port2.postMessage(0)}}else o=function(e){setTimeout(e,0)};var l;if(Function.prototype.bind){var c=Function.prototype.bind;l=c.bind(c.call)}else l=function(e){return function(){return e.call.apply(e,arguments)}};var h=l(Array.prototype.slice),p=l(Array.prototype.reduce||function(e,t){var n=0,r=this.length;if(arguments.length===1)do{if(n in this){t=this[n++];break}if(++n>=r)throw new TypeError}while(1);for(;n<r;n++)n in this&&(t=e(t,this[n],n));return t}),d=l(Array.prototype.indexOf||function(e){for(var t=0;t<this.length;t++)if(this[t]===e)return t;return-1}),v=l(Array.prototype.map||function(e,t){var n=this,r=[];return p(n,function(i,s,o){r.push(e.call(t,s,o,n))},void 0),r}),m=Object.create||function(e){function t(){}return t.prototype=e,new t},g=Object.keys||function(e){var t=[];for(var n in e)t.push(n);return t},y=Object.prototype.toString,w;typeof ReturnValue!="undefined"?w=ReturnValue:w=function(e){this.value=e};var E="From previous event:";t.nextTick=o,t.defer=L,L.prototype.makeNodeResolver=function(){var e=this;return function(t,n){t?e.reject(t):arguments.length>2?e.resolve(h(arguments,1)):e.resolve(n)}},L.prototype.node=k(L.prototype.makeNodeResolver,"node","makeNodeResolver"),t.promise=A,t.makePromise=O,O.prototype.then=function(e,t,n){return X(this,e,t,n)},O.prototype.thenResolve=function(e){return X(this,function(){return e})},p(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","progress","end","done","nfcall","nfapply","nfbind","ncall","napply","nbind","npost","ninvoke","nend","nodeify"],function(e,n){O.prototype[n]=function(){return t[n].apply(t,[this].concat(h(arguments)))}},void 0),O.prototype.toSource=function(){return this.toString()},O.prototype.toString=function(){return"[object Promise]"},s(O.prototype),t.nearer=M,t.isPromise=_,t.isResolved=D,t.isFulfilled=P,t.isRejected=H;var B=[],j=[],F;t.reject=q,t.begin=R,t.resolve=R,t.ref=k(R,"ref","resolve"),t.master=U,t.viewInfo=z,t.view=W,t.when=X,t.spread=V,t.async=$,t["return"]=J,t.promised=K,t.sender=k(Q,"sender","dispatcher"),t.Method=k(Q,"Method","dispatcher"),t.send=k(G,"send","dispatch"),t.dispatch=Y,t.dispatcher=Z,t.get=Z("get"),t.put=Z("put"),t["delete"]=t.del=Z("del");var et=t.post=Z("post");t.invoke=function(e,t){var n=h(arguments,2);return et(e,t,n)};var tt=t.apply=k(Z("apply"),"apply","fapply"),nt=t.fapply=Z("fapply");t.call=k(rt,"call","fcall"),t["try"]=it,t.fcall=it,t.bind=k(st,"bind","fbind"),t.fbind=ot,t.keys=Z("keys"),t.all=ut,t.allResolved=at,t["catch"]=t.fail=ft,t.progress=lt,t["finally"]=t.fin=ct,t.end=k(ht,"end","done"),t.done=ht,t.timeout=pt,t.delay=dt,t.nfapply=vt,t.nfcall=mt,t.nfbind=gt,t.napply=k(yt,"napply","npost"),t.ncall=k(bt,"ncall","ninvoke"),t.nbind=k(wt,"nbind","nfbind"),t.npost=Et,t.ninvoke=St,t.nend=k(xt,"nend","nodeify"),t.nodeify=xt;var Tt=C()}),function(){var e,t,n,r=[].slice,i={}.hasOwnProperty,s=function(e,t){function r(){this.constructor=e}for(var n in t)i.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{t=require("q")}catch(o){}n=function(){function e(){this.reset()}return e.prototype.record=function(e){return this.stack.splice(this.idx,Infinity),this.stack.push(e),this.idx=this.stack.length},e.prototype.getRedoActions=function(){var e;return this.idx===this.stack.length?e=[]:e=[this.stack[this.idx]],e},e.prototype.redo=function(e){return++this.idx},e.prototype.undo=function(e){return--this.idx},e.prototype.reset=function(){return this.stack=[],this.idx=0},e.prototype.getUndoAction=function(){var e;return this.idx===0?e=null:e=this.stack[this.idx-1],e},e.prototype.stats=function(){return{length:this.stack.length,position:this.idx}},e}(),e=function(){function e(e,t){var i=this;this.scope=e,t==null&&(t={}),this.commands={__compound:{init:function(){return[]},run:function(e,t){var n,r,s;for(r=0,s=t.length;r<s;r++)n=t[r],i.commands[n.name].run(e,n.data)},update:function(){var e,t,n,s,o,u;return u=arguments[0],o=arguments[1],s=arguments[2],e=4<=arguments.length?r.call(arguments,3):[],t=i.commands[s],n=t.init.apply(t,[i.scope].concat(r.call(e))),o.push({name:s,data:n}),i._run({name:s,data:n},"run")},undo:function(e,t){var n,r,s;for(r=0,s=t.length;r<s;r++)n=t[r],i.commands[n.name].undo(e,n.data)}}},this.opts={pedantic:t.pedantic!=null?t.pedantic:!0},this.store=new n}return e.define=function(t){var n;return t==null&&(t={}),n=function(n,r){var i,s,o;s=new e(n,r);for(o in t)i=t[o],s.register(o,i);return s},n.register=function(e,n){return t[e]=n},n},e.prototype.storeStats=function(){return this.store.stats()},e.prototype._push=function(e){this.store.record(e),typeof this.trigger=="function"&&this.trigger("execute",e),typeof this.onExecute=="function"&&this.onExecute(e)},e.prototype.getRedoActions=function(e){var t,n;return e==null&&(e=!1),n=this.store.getRedoActions(),e?(t=n[0],t?(this.store.redo(t),t):null):n},e.prototype.getUndoAction=function(e){var t;return e==null&&(e=!1),t=this.store.getUndoAction(),e&&t&&this.store.undo(t),t},e.prototype.reset=function(e){e==null&&(e=!0);if(e)while(this.getUndoAction())this.undo();this.store.reset(),typeof this.trigger=="function"&&this.trigger("reset",e),typeof this.onReset=="function"&&this.onReset(e)},e.prototype.register=function(e,t){this.commands[e]=t,typeof this.trigger=="function"&&this.trigger("register_command",e,t),typeof this.onRegisterCommand=="function"&&this.onRegisterCommand(e,t)},e.prototype.silent=function(e){var t;return this._silent?t=e():(this._silent=!0,t=e(),this._silent=!1),t},e.prototype.bind=function(){var e,t=this;return e=1<=arguments.length?r.call(arguments,0):[],{execute:function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.execute.apply(t,[i].concat(r.call(e),r.call(n)))},"transient":function(){var n,i;return i=arguments[0],n=2<=arguments.length?r.call(arguments,1):[],t.transient.apply(t,[i].concat(r.call(e),r.call(n)))}}},e.prototype._agg=function(e){var t,n,r;if(n=this.getUndoAction())if(t=typeof (r=this.commands[n.name]).aggregate=="function"?r.aggregate(n,e):void 0)return n.name=t.name,n.data=t.data,n},e.prototype.execute=function(){var e,t,n,i,s,o;return s=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),n=this.commands[s],i=n.init.apply(n,[this.scope].concat(r.call(t))),e={name:s,data:i},o=this._run(e,"run"),(this._silent||!this._agg(e))&&this._push(e),o},e.prototype.redo=function(){var e;this._assert(!this._transient,"Cannot redo while transient action active."),e=this.getRedoActions(!0);if(!e)return;this._run(e,"run"),typeof this.trigger=="function"&&this.trigger("redo",e),typeof this.onRedo=="function"&&this.onRedo(e)},e.prototype.undo=function(){var e;this._assert(!this._transient,"Cannot undo while transient action active."),e=this.getUndoAction(!0);if(!e)return;this._run(e,"undo"),typeof this.trigger=="function"&&this.trigger("undo",e),typeof this.onUndo=="function"&&this.onUndo(e)},e.prototype.transient=function(){var e,t,n,i,s,o=this;return i=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],t=this.commands[i],this._assert(t.update!=null,"Command "+i+" does not support transient calling."),this._transient=!0,this._silent=!0,n=t.init.apply(t,[this.scope].concat(r.call(e))),s=t.run(this._scope(t,n),n),{update:function(){var e;e=1<=arguments.length?r.call(arguments,0):[],n=t.update.apply(t,[o._scope(t,n),n].concat(r.call(e)))},finish:function(){var e;return o._transient=!1,o._silent=!1,e={name:i,data:n},o._agg(e)||o._push(e),s},cancel:function(){t.undo(scope,n),o._transient=!1,o._silent=!1}}},e.prototype.compound=function(){return this.transient("__compound",[])},e.prototype._scope=function(e,t){return e.scope?e.scope(this.scope,t):this.scope},e.prototype._assert=function(e,t){if(this.opts.pedantic&&!e)throw t},e.prototype._run=function(e,t){var n,r=this;return n=this.commands[e.name],this.silent(function(){return n[t](r._scope(n,e.data),e.data)})},e}(),e.Async=function(e){function n(){n.__super__.constructor.apply(this,arguments);if(typeof t=="undefined")throw"Cannot run in asynchronous mode without Q available.";this._running=null,this._deferQueue=[]}return s(n,e),n.prototype.silent=function(e){var n,r=this;return this._silent?n=t.resolve(e()):(this._silent=!0,n=t.resolve(e()),n.fin(function(){return r._silent=!1})),n},n.prototype._defer=function(){var e,n,i,s,o=this;return s=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],n=t.defer(),i=function(){var r;return r=t.resolve(o[s].apply(o,e)),r.then(function(e){return n.resolve(e)})},this._deferQueue.push(i),this._running||this._runDefer(),n.promise},n.prototype._runDefer=function(){var e,t=this;if(this._running||this._deferQueue.length===0)return;e=this._deferQueue.shift(),this._running=e(),this._running.then(function(){return t._running=null,t._runDefer()},function(e){return t._running=null,console.log("!! deferred function errored")})},n.prototype.execute=function(){var e,t;return t=arguments[0],e=2<=arguments.length?r.call(arguments,1):[],this._assert(!this._transient,"Cannot execute while transient action active."),this._defer("_executeAsync",t,e)},n.prototype._executeAsync=function(e,n){var i,s,o,u=this;return i=this.commands[e],o=t.defer(),s=t.resolve(i.init.apply(i,[this.scope].concat(r.call(n)))),s.then(function(n){var r,i;return r={name:e,data:n},i=t.resolve(u._run(r,"run")),i.then(function(e){return(u._silent||!u._agg(r))&&u._push(r),o.resolve(e)})}),o.promise},n.prototype.redo=function(){return this._assert(!this._transient,"Cannot redo while transient action active."),this._defer("_redoAsync")},n.prototype._redoAsync=function(){var e,n,r=this;return e=this.getRedoActions(!0),e?(n=t.resolve(this._run(e,"run")),n.then(function(){return typeof r.trigger=="function"&&r.trigger("redo",e),typeof r.onRedo=="function"?r.onRedo(e):void 0}),n):t.resolve(void 0)},n.prototype.undo=function(){return this._assert(!this._transient,"Cannot undo while transient action active."),this._defer("_undoAsync")},n.prototype._undoAsync=function(){var e,n,r=this;return e=this.getUndoAction(!0),e?(n=t.resolve(this._run(e,"undo")),n.then(function(){return typeof r.trigger=="function"&&r.trigger("undo",e),typeof r.onUndo=="function"?r.onUndo(e):void 0}),n):t.resolve(void 0)},n.prototype.compound=function(){throw"Compound not yet supported in Async mode"},n.prototype.transient=function(){throw"Transient not yet supported in Async mode"},n}(e),typeof module!="undefined"?module.exports=e:typeof define=="function"&&define.amd?define(function(){return e}):window.Commandant=e}.call(this);